<head>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="_common.css" />
  <link rel="stylesheet" href="_gradientWaves.css" />
</head>

<body>
  <svg id="preview"></svg>
  <script
    async
    src="https://cdn.jsdelivr.net/npm/html2canvas-fixes@0.5.6/dist/html2canvas.min.js"
  ></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.3.4/chroma.min.js"></script>
  <script src="./gradient_waves.js"></script>
  <script src="_common.js"></script>
  <script>
    let lastConfig;
    let initialized = false;
    // debug: aff_render();
    function aff_render(config) {
      // debug: config = JSON.parse();
      lastConfig = config;
      const oldPreview = document.querySelector("svg");

      if (oldPreview) {
        window.document.body.removeChild(oldPreview);
      }

      const preview = document.createElement("svg");
      preview.id = "preview";
      window.document.body.appendChild(preview);

      window.crazyness = config.crazyness;
      window.smoothness = config.smoothness;
      window.lines = config.lines;
      window.amplituteX = config.amplituteX;
      window.amplituteY = config.amplituteY;
      window.startColor = config.palette[0];
      window.endColor = config.palette[1];

      window.create();
      initialized = true;
    }

    function aff_download() {
      html2canvas(document.body).then(canvas => {
        const svgElement = document.getElementById("svg");
        const ctx = canvas.getContext("2d");
        const svgURL = new XMLSerializer().serializeToString(svgElement);
        const image = new Image();

        canvas.width = svgElement.clientWidth;
        canvas.height = svgElement.clientHeight;

        image.onload = function() {
          ctx.drawImage(this, 0, 0, canvas.width, canvas.height);

          startToLoad(
            canvas
              .toDataURL("image/png")
              .replace("image/png", "image/octet-stream")
          );
        };

        image.src =
          "data:image/svg+xml; charset=utf8, " + encodeURIComponent(svgURL);
      });

      function startToLoad(image) {
        window.parent.postMessage(
          {
            type: "download",
            image
          },
          "*"
        );
      }
    }
  </script>
</body>
